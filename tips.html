<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tips &mdash; APSW 3.43.1.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=b2705db7"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="copyright" title="Copyright" href="copyright.html" />
    <link rel="next" title="Example/Tour" href="example.html" />
    <link rel="prev" title="About" href="about.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            APSW
              <img src="_static/apswlogo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.43.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="about.html">About</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tips</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#sqlite-is-different">SQLite is different</a></li>
<li class="toctree-l2"><a class="reference internal" href="#transactions">Transactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cursors">Cursors</a></li>
<li class="toctree-l2"><a class="reference internal" href="#bindings">Bindings</a></li>
<li class="toctree-l2"><a class="reference internal" href="#diagnostics">Diagnostics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#managing-and-updating-your-schema">Managing and updating your schema</a></li>
<li class="toctree-l2"><a class="reference internal" href="#parsing-sql">Parsing SQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="#unexpected-behaviour">Unexpected behaviour</a></li>
<li class="toctree-l2"><a class="reference internal" href="#customizing-connections">Customizing Connections</a></li>
<li class="toctree-l2"><a class="reference internal" href="#customizing-cursors">Customizing Cursors</a></li>
<li class="toctree-l2"><a class="reference internal" href="#busy-handling">Busy handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="#database-schema">Database schema</a></li>
<li class="toctree-l2"><a class="reference internal" href="#shared-cache-mode">Shared Cache Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="#write-ahead-logging">Write Ahead Logging</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="example.html">Example/Tour</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation and customization</a></li>
<li class="toctree-l1"><a class="reference internal" href="extensions.html">Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="apsw.html">APSW Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="connection.html">Connections to a database</a></li>
<li class="toctree-l1"><a class="reference internal" href="cursor.html">Cursors (executing SQL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="blob.html">Blob Input/Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="backup.html">Backup</a></li>
<li class="toctree-l1"><a class="reference internal" href="vtable.html">Virtual Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="vfs.html">Virtual File System (VFS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="shell.html">Shell</a></li>
<li class="toctree-l1"><a class="reference internal" href="bestpractice.html">Best Practice</a></li>
<li class="toctree-l1"><a class="reference internal" href="ext.html">Various interesting and useful bits of functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="exceptions.html">Exceptions and Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="types.html">Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="execution.html">Execution and tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="dbapi.html">DBAPI notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="pysqlite.html">sqlite3 module differences</a></li>
<li class="toctree-l1"><a class="reference internal" href="benchmarking.html">Benchmarking</a></li>
<li class="toctree-l1"><a class="reference internal" href="copyright.html">Copyright and License</a></li>
<li class="toctree-l1"><a class="reference internal" href="changes.html">Change History</a></li>
<li class="toctree-l1"><a class="reference internal" href="py-modindex.html">Module Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="genindex.html">Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">APSW</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Tips</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/tips.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul><div class="rst-breadcrumbs-buttons" role="navigation" aria-label="Sequential page navigation">
        <a href="about.html" class="btn btn-neutral float-left" title="About" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="example.html" class="btn btn-neutral float-right" title="Example/Tour" accesskey="n">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
  </div>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tips">
<h1>Tips<a class="headerlink" href="#tips" title="Link to this heading"></a></h1>
<p>These tips are based on mailing list postings, issues, and emails.
You are recommended to read all the documentation as well.</p>
<section id="sqlite-is-different">
<h2>SQLite is different<a class="headerlink" href="#sqlite-is-different" title="Link to this heading"></a></h2>
<p>While SQLite provides a SQL database like many others out there, it is
also unique in many ways.  Read about the unique features at the
<a class="reference external" href="https://sqlite.org/different.html">SQLite website</a> and <a class="reference external" href="https://www.sqlite.org/quirks.html">quirks</a>.</p>
<p><a class="reference internal" href="bestpractice.html"><span class="doc">Best practice</span></a> is recommended.</p>
</section>
<section id="transactions">
<h2>Transactions<a class="headerlink" href="#transactions" title="Link to this heading"></a></h2>
<p>Transactions are the changes applied to a database file as a whole.
They either happen completely, or not at all.  SQLite notes all the changes
made during a transaction, and at the end when you do a commit will cause
them to permanently end up in the database.  If you do not commit, or
just exit, then other/new connections will not see the changes and SQLite
handles tidying up the work in progress automatically.</p>
<p>Committing a transaction can be quite time consuming.  SQLite uses a robust
multi-step process that has to handle errors that can occur at any point,
and asks the operating system to ensure that data is on storage and would
survive a power cycle.  This will <a class="reference external" href="https://www.sqlite.org/faq.html#q19">limit the rate at which you can do
transactions</a>.</p>
<p>If you do nothing, then each statement is a single transaction:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># this will be 3 separate transactions</span>
<span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT ...&quot;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT ...&quot;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT ...&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>You can use BEGIN/COMMIT to set the transaction boundary:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># this will be one transaction</span>
<span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;BEGIN&quot;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT ...&quot;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT ...&quot;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT ...&quot;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;COMMIT&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>However that is extra effort, and also requires error handling.  For example
if the second INSERT failed then you likely want to ROLLBACK the incomplete
transaction, so that additional work on the same connection doesn't see the
partial data.</p>
<p>If you use <a class="reference internal" href="connection.html#apsw.Connection.__enter__" title="apsw.Connection.__enter__"><code class="xref py py-meth docutils literal notranslate"><span class="pre">with</span> <span class="pre">Connection</span></code></a> then the transaction
will be automatically started, and committed on success or rolled back if
exceptions occur:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># this will be one transaction with automatic commit and rollback</span>
<span class="k">with</span> <span class="n">db</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT ...&quot;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT ...&quot;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT ...&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>There are <a class="reference external" href="https://www.sqlite.org/lang_transaction.html">technical details</a>
at the <a class="reference external" href="https://www.sqlite.org/docs.html">SQLite site</a>.</p>
</section>
<section id="cursors">
<h2>Cursors<a class="headerlink" href="#cursors" title="Link to this heading"></a></h2>
<p>SQLite only calculates each result row as you request it.  For example
if your query returns 10 million rows SQLite will not calculate all 10
million up front.  Instead the next row will be calculated as you ask
for it.</p>
<p>Cursors on the same <a class="reference internal" href="connection.html#connections"><span class="std std-ref">Connection</span></a> are not isolated
from each other.  Anything done on one cursor is immediately visible
to all other Cursors on the same connection.  This still applies if
you start transactions.  Connections are isolated from each other.</p>
<p>Cursor objects are obtained by <a class="reference internal" href="connection.html#apsw.Connection.cursor" title="apsw.Connection.cursor"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.cursor()</span></code></a> and are very
cheap.  It is best practise to not re-use them, and instead get a new one
each time.  If you don't, code refactoring and nested loops can unintentionally
use the same cursor object which will not crash but will cause hard to
diagnose behaviour in your program.</p>
<p>Read more about <a class="reference internal" href="cursor.html#cursors"><span class="std std-ref">Cursors</span></a>.</p>
</section>
<section id="bindings">
<h2>Bindings<a class="headerlink" href="#bindings" title="Link to this heading"></a></h2>
<p>When using a cursor, always use bindings.  <a class="reference external" href="https://docs.python.org/library/stdtypes.html#printf-style-string-formatting">String interpolation</a>
may seem more convenient but you will encounter difficulties.  You may
feel that you have complete control over all data accessed but if your
code is at all useful then you will find it being used more and more
widely.  The computer will always be better than you at parsing SQL
and the bad guys have years of experience finding and using <a class="reference external" href="https://en.wikipedia.org/wiki/SQL_injection">SQL
injection attacks</a> in
ways you never even thought possible.</p>
<p>The <a class="reference internal" href="cursor.html#cursors"><span class="std std-ref">documentation</span></a> gives many examples of how to use
various forms of bindings.</p>
</section>
<section id="diagnostics">
<span id="diagnostics-tips"></span><h2>Diagnostics<a class="headerlink" href="#diagnostics" title="Link to this heading"></a></h2>
<p>Both SQLite and APSW provide detailed diagnostic information.  Errors
will be signalled via an <a class="reference internal" href="exceptions.html"><span class="doc">exception</span></a>.</p>
<p>APSW ensures you have <a class="reference internal" href="exceptions.html#augmentedstacktraces"><span class="std std-ref">detailed information</span></a> both in the stack trace as well as what data
APSW/SQLite was operating on.</p>
<p>SQLite has a <a class="reference external" href="https://www.sqlite.org/errlog.html">warning/error logging facility</a>.  You can call
<a class="reference internal" href="ext.html#apsw.ext.log_sqlite" title="apsw.ext.log_sqlite"><code class="xref py py-meth docutils literal notranslate"><span class="pre">apsw.ext.log_sqlite()</span></code></a> which installs a handler that forwards
SQLite messages to the <a class="reference external" href="https://docs.python.org/3/library/logging.html#module-logging" title="(in Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">logging</span> <span class="pre">module</span></code></a>.`</p>
<p>To do it yourself:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">errcode</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="n">errstr</span><span class="o">=</span><span class="n">apsw</span><span class="o">.</span><span class="n">mapping_result_codes</span><span class="p">[</span><span class="n">errcode</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">]</span>
    <span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SQLITE_LOG: </span><span class="si">{</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="w"> </span><span class="n">errcode</span><span class="w"> </span><span class="si">}</span><span class="s2">) </span><span class="si">{</span><span class="w"> </span><span class="n">errstr</span><span class="w"> </span><span class="si">}</span><span class="s2"> &quot;</span>
           <span class="o">+</span> <span class="n">apsw</span><span class="o">.</span><span class="n">mapping_extended_result_codes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">errcode</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

<span class="n">apsw</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">apsw</span><span class="o">.</span><span class="n">SQLITE_CONFIG_LOG</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
</pre></div>
</div>
<p>This is an example of what gets printed when I use <code class="docutils literal notranslate"><span class="pre">/dev/null</span></code> as
the database name in the <a class="reference internal" href="connection.html#apsw.Connection" title="apsw.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> and then tried to create
a table.</p>
<div class="highlight-output notranslate"><div class="highlight"><pre><span></span><span class="go">SQLITE_LOG: cannot open file at line 28729 of [7dd4968f23] (14) SQLITE_CANTOPEN</span>
<span class="go">SQLITE_LOG: os_unix.c:28729: (2) open(/dev/null-journal) - No such file or directory (14) SQLITE_CANTOPEN</span>
<span class="go">SQLITE_LOG: statement aborts at 38: [create table foo(x,y);] unable to open database file (14) SQLITE_CANTOPEN</span>
</pre></div>
</div>
</section>
<section id="managing-and-updating-your-schema">
<h2>Managing and updating your schema<a class="headerlink" href="#managing-and-updating-your-schema" title="Link to this heading"></a></h2>
<p>If your program uses SQLite for <a class="reference external" href="https://sqlite.org/appfileformat.html">data</a> then you'll need to manage
and update your schema.  The hard way of doing this is to test for the
existence of tables and their columns, and doing that maintenance
programmatically.  The easy way is to use <a class="reference external" href="https://sqlite.org/pragma.html#pragma_user_version">pragma user_version</a> as in this example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ensure_schema</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
  <span class="c1"># a new database starts at user_version 0</span>
  <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">pragma</span><span class="p">(</span><span class="s2">&quot;user_version&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">db</span><span class="p">:</span>
      <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS foo(x,y,z);</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS bar(x,y,z);</span>
<span class="s2">        PRAGMA user_version = 1;&quot;&quot;&quot;</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">pragma</span><span class="p">(</span><span class="s2">&quot;user_version&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">db</span><span class="p">:</span>
      <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">      CREATE TABLE IF NOT EXISTS baz(x,y,z);</span>
<span class="s2">      CREATE INDEX ....</span>
<span class="s2">      PRAGMA user_version = 2;&quot;&quot;&quot;</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">pragma</span><span class="p">(</span><span class="s2">&quot;user_version&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">db</span><span class="p">:</span>
      <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">      ALTER TABLE .....</span>
<span class="s2">      PRAGMA user_version = 3;&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This approach will automatically upgrade the schema as you expect.
You can also use <a class="reference external" href="https://sqlite.org/pragma.html#pragma_application_id">pragma application_id</a> to mark the
database as made by your application.</p>
</section>
<section id="parsing-sql">
<h2>Parsing SQL<a class="headerlink" href="#parsing-sql" title="Link to this heading"></a></h2>
<p>Sometimes you want to know what a particular SQL statement does.  Use
<a class="reference internal" href="ext.html#apsw.ext.query_info" title="apsw.ext.query_info"><code class="xref py py-func docutils literal notranslate"><span class="pre">apsw.ext.query_info()</span></code></a> which will provide as much detail as you
need.</p>
</section>
<section id="unexpected-behaviour">
<h2>Unexpected behaviour<a class="headerlink" href="#unexpected-behaviour" title="Link to this heading"></a></h2>
<p>Occasionally you may get different results than you expected.  Before
littering your code with <em>print</em>, try <a class="reference internal" href="execution.html#apswtrace"><span class="std std-ref">apswtrace</span></a>
with all options turned on to see exactly what is going on. You can
also use the <a class="reference internal" href="shell.html#shell"><span class="std std-ref">SQLite shell</span></a> to dump the contents of your
database to a text file.  For example you could dump it before and
after a run to see what changed.</p>
<p>One fairly common gotcha is using double quotes instead of single
quotes.  (This wouldn't be a problem if you use bindings!)  SQL
strings use single quotes.  If you use double quotes then it will
mostly appear to work, but they are intended to be used for
identifiers such as column names.  For example if you have a column
named <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">b</span></code> (a space b) then you would need to use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="s2">&quot;a b&quot;</span> <span class="kn">from</span> <span class="nn">table</span>
</pre></div>
</div>
<p>If you use double quotes and happen to use a string whose contents are
the same as a table, alias, column etc then unexpected results will
occur.</p>
</section>
<section id="customizing-connections">
<span id="customizing-connection-cursor"></span><h2>Customizing Connections<a class="headerlink" href="#customizing-connections" title="Link to this heading"></a></h2>
<p><a class="reference internal" href="apsw.html#apsw.connection_hooks" title="apsw.connection_hooks"><code class="xref py py-attr docutils literal notranslate"><span class="pre">apsw.connection_hooks</span></code></a> is a list of callbacks for when
each <a class="reference internal" href="connection.html#apsw.Connection" title="apsw.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> is created.  They are called in turn, with
the new connection as the only parameter.</p>
<p>For example if you wanted to add an <cite>executescript</cite> method to
Connections that is like <a class="reference internal" href="connection.html#apsw.Connection.execute" title="apsw.Connection.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.execute()</span></code></a> but ignores all
returned rows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">executescript</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">bindings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">bindings</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">my_hook</span><span class="p">(</span><span class="n">connection</span><span class="p">):</span>
  <span class="n">connection</span><span class="o">.</span><span class="n">executescript</span> <span class="o">=</span> <span class="n">executescript</span>

<span class="n">apsw</span><span class="o">.</span><span class="n">connection_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">my_hook</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="customizing-cursors">
<h2>Customizing Cursors<a class="headerlink" href="#customizing-cursors" title="Link to this heading"></a></h2>
<p>You can customize the behaviour of cursors.  An example would be
wanting a <a class="reference internal" href="dbapi.html#rowcount"><span class="std std-ref">rowcount</span></a> or batching returned rows.
(These don't make any sense with SQLite but the desire may be to make
the code source compatible with other database drivers).</p>
<p>Set <a class="reference internal" href="connection.html#apsw.Connection.cursor_factory" title="apsw.Connection.cursor_factory"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Connection.cursor_factory</span></code></a> to any callable, which will be
called with the connection as the only parameter, and return the
object to use as a cursor.</p>
<p>For example instead of returning rows as tuples, we can return them as
dictionaries using a <a class="reference internal" href="execution.html#rowtracer"><span class="std std-ref">row tracer</span></a> with
<a class="reference internal" href="cursor.html#apsw.Cursor.getdescription" title="apsw.Cursor.getdescription"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Cursor.getdescription()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">dict_row</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
  <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">getdescription</span><span class="p">())}</span>

<span class="k">def</span> <span class="nf">my_factory</span><span class="p">(</span><span class="n">connection</span><span class="p">):</span>
  <span class="n">cursor</span> <span class="o">=</span> <span class="n">apsw</span><span class="o">.</span><span class="n">Cursor</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
  <span class="n">cursor</span><span class="o">.</span><span class="n">rowtrace</span> <span class="o">=</span> <span class="n">dict_row</span>
  <span class="k">return</span> <span class="n">cursor</span>

<span class="n">connection</span><span class="o">.</span><span class="n">cursor_factory</span> <span class="o">=</span> <span class="n">my_factory</span>
</pre></div>
</div>
</section>
<section id="busy-handling">
<span id="busyhandling"></span><h2>Busy handling<a class="headerlink" href="#busy-handling" title="Link to this heading"></a></h2>
<p>SQLite uses locks to coordinate access to the database by multiple
connections (within the same process or in a different process).  The
general goal is to have the locks be as lax as possible (allowing
concurrency) and when using more restrictive locks to keep them for as
short a time as possible.  See the <a class="reference external" href="https://sqlite.org/lockingv3.html">SQLite documentation</a> for more details.</p>
<p>By default you will get a <a class="reference internal" href="exceptions.html#apsw.BusyError" title="apsw.BusyError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">BusyError</span></code></a> if a lock cannot be
acquired.  You can set a <a class="reference internal" href="connection.html#apsw.Connection.setbusytimeout" title="apsw.Connection.setbusytimeout"><code class="xref py py-meth docutils literal notranslate"><span class="pre">timeout</span></code></a>
which will keep retrying or a <a class="reference internal" href="connection.html#apsw.Connection.setbusyhandler" title="apsw.Connection.setbusyhandler"><code class="xref py py-meth docutils literal notranslate"><span class="pre">callback</span></code></a> where you decide what to do.</p>
</section>
<section id="database-schema">
<h2>Database schema<a class="headerlink" href="#database-schema" title="Link to this heading"></a></h2>
<p>When starting a new database, it can be quite difficult to decide what
tables and fields to have and how to link them.  The technique used to
design SQL schemas is called <a class="reference external" href="https://en.wikipedia.org/wiki/Database_normalization">normalization</a>.  The page
also shows common pitfalls if you don't normalize your schema.</p>
</section>
<section id="shared-cache-mode">
<span id="sharedcache"></span><h2>Shared Cache Mode<a class="headerlink" href="#shared-cache-mode" title="Link to this heading"></a></h2>
<p>SQLite supports a <a class="reference external" href="https://sqlite.org/sharedcache.html">shared cache mode</a> where multiple connections
to the same database can share a cache instead of having their own.
It is not recommended that you use this mode.</p>
<p>A big issue is that <a class="reference internal" href="#busyhandling"><span class="std std-ref">busy handling</span></a> is not done
the same way.  The timeouts and handlers are ignored and instead
<em>SQLITE_LOCKED_SHAREDCACHE</em> extended error is returned.
Consequently you will have to do your own busy handling.  (<a class="reference external" href="https://sqlite.org/src/tktview/ebde3f66fc64e21e61ef2854ed1a36dfff884a2f">SQLite
ticket</a>,
<a class="reference external" href="https://github.com/rogerbinns/apsw/issues/59">APSW issue 59</a>)</p>
<p>The amount of memory and I/O saved is trivial compared to Python's
overall memory and I/O consumption.  You may also need to tune the
shared cache's memory back up to what it would have been with separate
connections to get the same performance.</p>
<p>The shared cache mode is targeted at embedded systems where every
byte of memory and I/O matters.  For example an MP3 player may only
have kilobytes of memory available for SQLite.</p>
</section>
<section id="write-ahead-logging">
<span id="wal"></span><h2>Write Ahead Logging<a class="headerlink" href="#write-ahead-logging" title="Link to this heading"></a></h2>
<p>SQLite 3.7 introduced <a class="reference external" href="https://sqlite.org/wal.html">write ahead logging</a> which has several benefits, but
also some drawbacks as the page documents.  WAL mode is off by
default.  In addition to turning it on manually for each database, you
can also turn it on for all opened databases by using
<a class="reference internal" href="apsw.html#apsw.connection_hooks" title="apsw.connection_hooks"><code class="xref py py-attr docutils literal notranslate"><span class="pre">connection_hooks</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">setwal</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;pragma journal_mode=wal&quot;</span><span class="p">)</span>
    <span class="c1"># custom auto checkpoint interval (use zero to disable)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">wal_autocheckpoint</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="n">apsw</span><span class="o">.</span><span class="n">connection_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">setwal</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that if wal mode can't be set (eg the database is in memory or
temporary) then the attempt to set wal mode will be ignored.  The
pragma will return the mode in effect.  It is also harmless to call
functions like <a class="reference internal" href="connection.html#apsw.Connection.wal_autocheckpoint" title="apsw.Connection.wal_autocheckpoint"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.wal_autocheckpoint()</span></code></a> on connections
that are not in wal mode.</p>
<p>If you write your own VFS, then inheriting from an existing VFS that
supports WAL will make your VFS support the extra WAL methods too.
(Your VFS will point directly to the base methods - there is no
indirect call via Python.)</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="about.html" class="btn btn-neutral float-left" title="About" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="example.html" class="btn btn-neutral float-right" title="Example/Tour" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="copyright.html">Copyright</a> 2004-2023, Roger Binns &lt;rogerb@rogerbinns.com&gt;.
      <span class="lastupdated">Last updated on Sep 13, 2023.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2NR9GDCQLT"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-2NR9GDCQLT', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>